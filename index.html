<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>LaChispa TPV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .card { border: 1px solid #ccc; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    label { display: block; margin-top: 10px; }
    input, select, button, textarea { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #aaa; }
    button { background: #ff6600; color: white; font-weight: bold; cursor: pointer; }
    #invoiceBox { margin-top: 20px; padding: 15px; border: 2px dashed #ff6600; border-radius: 10px; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>

  <h2>ðŸ’¡ LaChispa TPV</h2>
  <div class="card">
    <label>Producto o Servicio</label>
    <input type="text" id="descripcion" placeholder="Ej: CafÃ©, recarga, transporte">

    <label>Monto</label>
    <input type="number" id="monto" placeholder="Ej: 500">

    <label>Moneda</label>
    <select id="moneda">
      <option value="CUP">CUP</option>
      <option value="USD">USD</option>
    </select>

    <label>Tasa BTC usada</label>
    <div id="tasa">Cargando...</div>

    <button onclick="crearFactura()">Generar Factura Lightning</button>
  </div>

  <div id="invoiceBox" style="display:none;">
    <h3>âš¡ Factura Lightning generada</h3>
    <p><b>Monto:</b> <span id="resMonto"></span> sats</p>
    <p><b>DescripciÃ³n:</b> <span id="resDesc"></span></p>
    <label>Invoice Lightning:</label>
    <pre id="resInvoice"></pre>
  </div>

  <script>
    const YADIO_API = "https://api.yadio.io/exrates/BTC";
    const LNBITS_URL = "https://lnbits.cubabitcoin.org"; // tu servidor LNbits
    let LN_API_KEY = null; // la pedirÃ¡ el dueÃ±o con PIN

    // Pedir PIN y API key al inicio
    window.onload = () => {
      const pin = prompt("DueÃ±o: ingrese su PIN para configurar API Key de LNbits:");
      if(pin){
        LN_API_KEY = prompt("Introduzca su API Key de LNbits (cartera custodial):");
      }
      actualizarTasa();
    }

    async function actualizarTasa(){
      try{
        let res = await fetch(YADIO_API);
        let data = await res.json();
        window.tasaCUP = 1 / data.CUP; // sats por CUP
        window.tasaUSD = 1 / data.USD; // sats por USD
        document.getElementById("tasa").innerText = `1 BTC = ${data.CUP} CUP / ${data.USD} USD`;
      }catch(e){
        document.getElementById("tasa").innerText = "Error al obtener tasa";
      }
    }

    async function crearFactura(){
      const descripcion = document.getElementById("descripcion").value;
      const monto = parseFloat(document.getElementById("monto").value);
      const moneda = document.getElementById("moneda").value;

      if(!descripcion || !monto){ alert("Ingrese todos los datos"); return; }

      let sats = 0;
      if(moneda === "CUP") sats = Math.round(monto * window.tasaCUP * 100_000_000);
      if(moneda === "USD") sats = Math.round(monto * window.tasaUSD * 100_000_000);

      // Llamada real a LNbits
      try{
        const res = await fetch(LNBITS_URL + "/api/v1/payments", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Api-Key": LN_API_KEY
          },
          body: JSON.stringify({
            out: false,
            amount: sats,
            memo: descripcion
          })
        });
        const data = await res.json();

        document.getElementById("invoiceBox").style.display = "block";
        document.getElementById("resMonto").innerText = sats;
        document.getElementById("resDesc").innerText = descripcion;
        document.getElementById("resInvoice").innerText = data.payment_request;
      }catch(err){
        alert("Error al crear factura en LNbits: " + err);
      }
    }
  </script>
</body>
</html>
